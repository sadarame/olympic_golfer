    <!DOCTYPE html>
    <html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>オリンピックゴルフスコア記録</title>
        <!-- Tailwind CSS CDN -->
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            /* Interフォントの指定 */
            body {
                font-family: 'Inter', sans-serif;
                background-color: #f3f4f6; /* 薄いグレーの背景 */
                color: #333;
            }
            /* カスタムスクロールバー（オプション） */
            ::-webkit-scrollbar {
                width: 8px;
            }
            ::-webkit-scrollbar-track {
                background: #e0e0e0;
                border-radius: 10px;
            }
            ::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 10px;
            }
            ::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
            /* ボーナスボタンの選択状態 */
            .selected-bonus {
                outline: 2px solid #3b82f6; /* 青い枠線 */
                outline-offset: 2px;
                box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
            }
        </style>
    </head>
    <body class="min-h-screen p-4">
    <header class="bg-white shadow-md p-4 mb-8 flex justify-between items-center">
        <h1 class="text-xl font-bold text-green-700">⛳ オリンピックゴルフスコア</h1>
        <div>
            {% if user_info %}
                <span class="text-gray-700">ようこそ、{{ user_info.name }}さん</span>
                <a href="/logout" class="ml-4 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition duration-300 ease-in-out">ログアウト</a>
            {% else %}
                <a href="{{ url_for('google.login') }}" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition duration-300 ease-in-out">Googleでログイン</a>
            {% endif %}
        </div>
    </header>
        <div id="app-container" class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md mx-auto my-8">

            <!-- 1. ホーム画面 -->
            <section id="home-section" class="active">
                <h1 class="text-3xl font-bold text-center mb-6 text-green-700">⛳ オリンピックゴルフスコア</h1>
                <p class="text-center text-gray-600 mb-8">ゴルフのオリンピック形式のスコアを簡単に記録しましょう！</p>
                <button id="resume-round-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 mb-4 hidden">
                    <i class="fas fa-redo mr-2"></i> ラウンドを再開
                </button>
                <button id="start-new-round-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    <i class="fas fa-plus-circle mr-2"></i> 新規ラウンドを開始
                </button>
                <div class="mt-6 text-center">
                    <button id="view-history-btn" class="text-blue-600 hover:text-blue-800 font-semibold py-2 px-4 rounded-lg transition duration-300 ease-in-out">
                        <i class="fas fa-history mr-2"></i> 過去のラウンド履歴 (開発中)
                    </button>
                </div>
            </section>

            <!-- 2. ラウンド設定画面 -->
            <section id="setup-section" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-6 text-green-700">ラウンド設定</h2>

                <div class="mb-4">
                    <label for="course-name" class="block text-gray-700 text-sm font-bold mb-2">
                        コース名:
                    </label>
                    <input type="text" id="course-name" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-green-500" placeholder="例: 〇〇カントリークラブ">
                </div>

                <div class="mb-4">
                    <label for="bet-amount" class="block text-gray-700 text-sm font-bold mb-2">
                        1ポイントあたりの賭け金 (円):
                    </label>
                    <input type="number" id="bet-amount" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-green-500" value="100" min="0">
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">
                        プレイヤー:
                    </label>
                    <div id="players-container">
                        <!-- プレイヤー入力フィールドがここに追加される -->
                    </div>
                    <button id="add-player-btn" class="mt-3 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        <i class="fas fa-user-plus mr-2"></i> プレイヤーを追加
                    </button>
                </div>

                <div class="flex justify-between">
                    <button id="back-to-home-from-setup-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        <i class="fas fa-arrow-left mr-2"></i> 戻る
                    </button>
                    <button id="start-round-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        <i class="fas fa-play-circle mr-2"></i> ラウンドを開始
                    </button>
                </div>
            </section>

            <!-- 3. ラウンド記録画面 -->
            <section id="record-section" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-4 text-green-700">ラウンド記録</h2>

                <div class="text-center mb-6">
                    <p class="text-gray-600 text-lg">現在のホール:</p>
                    <p id="current-hole-display" class="text-4xl font-extrabold text-green-800">HOLE 1</p>
                    <p id="hole-par-display" class="text-xl text-gray-700">PAR 4</p>
                </div>

                <div id="player-score-inputs" class="space-y-4 mb-6">
                    <!-- プレイヤーごとのスコア入力とボーナスボタンがここに追加される -->
                </div>

                <div class="bg-green-50 p-4 rounded-lg shadow-inner mb-6">
                    <h3 class="text-lg font-bold text-green-800 mb-2">現在のポイント状況</h3>
                    <div id="current-points-summary" class="grid grid-cols-2 gap-2 text-sm">
                        <!-- プレイヤーごとのポイントサマリーがここに追加される -->
                    </div>
                </div>

                <div class="flex justify-between mt-6">
                    <button id="prev-hole-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        <i class="fas fa-arrow-left mr-2"></i> 前のホール
                    </button>
                    <button id="next-hole-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        <i class="fas fa-arrow-right mr-2"></i> 次のホール
                    </button>
                </div>
                <button id="end-round-btn" class="w-full mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    <i class="fas fa-flag-checkered mr-2"></i> ラウンドを終了
                </button>
            </section>

            <!-- 4. ラウンド結果画面 -->
            <section id="results-section" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-6 text-green-700">ラウンド結果</h2>

                <div id="final-winner-display" class="text-center mb-6">
                    <p class="text-gray-600 text-lg">最終的な勝者:</p>
                    <p class="text-4xl font-extrabold text-indigo-700">まだ計算されていません</p>
                </div>

                <div class="bg-blue-50 p-4 rounded-lg shadow-inner mb-6">
                    <h3 class="text-lg font-bold text-blue-800 mb-2">プレイヤー別最終成績</h3>
                    <div id="final-player-summary" class="space-y-2">
                        <!-- プレイヤーごとの最終成績がここに追加される -->
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-bold text-gray-700 mb-2">ホール別詳細</h3>
                    <div id="hole-by-hole-details" class="space-y-4">
                        <!-- ホールごとの詳細がここに追加される -->
                    </div>
                </div>

                <button id="back-to-home-from-results-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    <i class="fas fa-home mr-2"></i> ホームに戻る
                </button>
            </section>

            <!-- メッセージボックス（alertの代わり） -->
            <div id="message-box" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
                <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full text-center">
                    <p id="message-content" class="text-lg font-semibold mb-4"></p>
                    <button id="message-ok-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out">OK</button>
                </div>
            </div>

        </div>

        <script>
            // グローバル変数と初期設定
            let currentRound = {
                courseName: '',
                betAmount: 100,
                players: [], // { name: 'Player A', scores: [], holeBonuses: [], currentPoints: 0, totalPoints: 0 }
                currentHole: 1,
                maxHoles: 18, // 通常のゴルフは18ホール
                holePars: [4, 4, 3, 5, 4, 3, 4, 5, 4, 4, 4, 3, 5, 4, 3, 4, 5, 4] // 例: 18ホールのパー設定
            };

            // DOM要素の取得
            const homeSection = document.getElementById('home-section');
            const setupSection = document.getElementById('setup-section');
            const recordSection = document.getElementById('record-section');
            const resultsSection = document.getElementById('results-section');

            const resumeRoundBtn = document.getElementById('resume-round-btn'); // 新しく追加
            const startNewRoundBtn = document.getElementById('start-new-round-btn');
            const backToHomeFromSetupBtn = document.getElementById('back-to-home-from-setup-btn');
            const startRoundBtn = document.getElementById('start-round-btn');
            const addPlayerBtn = document.getElementById('add-player-btn');
            const playersContainer = document.getElementById('players-container');
            const courseNameInput = document.getElementById('course-name');
            const betAmountInput = document.getElementById('bet-amount');

            const currentHoleDisplay = document.getElementById('current-hole-display');
            const holeParDisplay = document.getElementById('hole-par-display');
            const playerScoreInputs = document.getElementById('player-score-inputs');
            const currentPointsSummary = document.getElementById('current-points-summary');
            const prevHoleBtn = document.getElementById('prev-hole-btn');
            const nextHoleBtn = document.getElementById('next-hole-btn');
            const endRoundBtn = document.getElementById('end-round-btn');

            const finalWinnerDisplay = document.getElementById('final-winner-display');
            const finalPlayerSummary = document.getElementById('final-player-summary');
            const holeByHoleDetails = document.getElementById('hole-by-hole-details');
            const backToHomeFromResultsBtn = document.getElementById('back-to-home-from-results-btn');

            const messageBox = document.getElementById('message-box');
            const messageContent = document.getElementById('message-content');
            const messageOkBtn = document.getElementById('message-ok-btn');

            // メッセージボックスを表示する関数 (alertの代わり)
            function showMessageBox(message) {
                messageContent.textContent = message;
                messageBox.classList.remove('hidden');
            }

            // メッセージボックスを非表示にする関数
            messageOkBtn.addEventListener('click', () => {
                messageBox.classList.add('hidden');
            });

            // セクション表示切り替え関数
            function showSection(sectionToShow) {
                [homeSection, setupSection, recordSection, resultsSection].forEach(section => {
                    section.classList.add('hidden');
                });
                sectionToShow.classList.remove('hidden');
            }

            // プレイヤー入力フィールドを追加する関数
            function addPlayerInput(playerName = '') {
                const playerCount = playersContainer.children.length;
                const playerDiv = document.createElement('div');
                playerDiv.className = 'flex items-center mb-2';
                playerDiv.innerHTML = `
                    <input type="text" placeholder="プレイヤー名" value="${playerName}"
                        class="player-name-input shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-green-500 mr-2">
                    <button class="remove-player-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg shadow-sm transition duration-300 ease-in-out">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                playersContainer.appendChild(playerDiv);

                // 削除ボタンのイベントリスナー
                playerDiv.querySelector('.remove-player-btn').addEventListener('click', () => {
                    if (playersContainer.children.length > 1) { // 少なくとも1人は残す
                        playersContainer.removeChild(playerDiv);
                    } else {
                        showMessageBox('プレイヤーは少なくとも1人必要です。');
                    }
                });
            }

            // ラウンド設定の初期化
            function initializeSetup() {
                playersContainer.innerHTML = ''; // 既存のプレイヤーをクリア
                addPlayerInput('プレイヤー1'); // 初期プレイヤーを追加
                addPlayerInput('プレイヤー2');
                courseNameInput.value = '';
                betAmountInput.value = 100;
            }

            // localStorageにゲーム状態を保存する関数
            function saveGame() {
                try {
                    localStorage.setItem('golfSavedRound', JSON.stringify(currentRound));
                } catch (e) {
                    console.error('Failed to save game to localStorage:', e);
                    showMessageBox('ゲームの保存に失敗しました。ブラウザのストレージがいっぱいかもしれません。');
                }
            }

            // localStorageからゲーム状態を読み込む関数
            function loadGame() {
                try {
                    const savedData = localStorage.getItem('golfSavedRound');
                    if (savedData) {
                        return JSON.parse(savedData);
                    }
                } catch (e) {
                    console.error('Failed to load game from localStorage:', e);
                    // 破損したデータの場合はクリア
                    clearSavedGame();
                }
                return null;
            }

            // localStorageから保存されたゲームをクリアする関数
            function clearSavedGame() {
                localStorage.removeItem('golfSavedRound');
            }


            // イベントリスナー
            startNewRoundBtn.addEventListener('click', () => {
                clearSavedGame(); // 新規ラウンド開始時は保存データをクリア
                initializeSetup();
                showSection(setupSection);
            });

            // ラウンド再開ボタンのイベントリスナー
            resumeRoundBtn.addEventListener('click', () => {
                const savedRound = loadGame();
                if (savedRound) {
                    currentRound = savedRound; // 保存されたデータを現在のラウンドにセット
                    initializeRecordSection(); // 記録画面を初期化
                    showSection(recordSection); // 記録画面を表示
                } else {
                    showMessageBox('保存されたラウンドが見つかりません。');
                    resumeRoundBtn.classList.add('hidden'); // ボタンを非表示にする
                }
            });

            backToHomeFromSetupBtn.addEventListener('click', () => {
                showSection(homeSection);
                checkSavedGameAndShowResumeButton(); // ホームに戻ったら再開ボタンの状態を更新
            });

            addPlayerBtn.addEventListener('click', () => {
                addPlayerInput();
            });

            startRoundBtn.addEventListener('click', () => {
                const courseName = courseNameInput.value.trim();
                const betAmount = parseInt(betAmountInput.value, 10);
                const playerNames = Array.from(document.querySelectorAll('.player-name-input'))
                                        .map(input => input.value.trim())
                                        .filter(name => name !== '');

                if (!courseName) {
                    showMessageBox('コース名を入力してください。');
                    return;
                }
                if (isNaN(betAmount) || betAmount < 0) {
                    showMessageBox('賭け金は0以上の数値を入力してください。');
                    return;
                }
                if (playerNames.length === 0) {
                    showMessageBox('プレイヤーを1人以上追加してください。');
                    return;
                }
                if (playerNames.some((name, index, arr) => arr.indexOf(name) !== index)) {
                    showMessageBox('プレイヤー名が重複しています。');
                    return;
                }

                currentRound.courseName = courseName;
                currentRound.betAmount = betAmount;
                currentRound.players = playerNames.map(name => ({
                    name: name,
                    scores: Array(currentRound.maxHoles).fill(null), // 各ホールのスコアをnullで初期化
                    holeBonuses: Array(currentRound.maxHoles).fill(null), // 各ホールのボーナスをnullで初期化
                    currentPoints: 0, // 現在のホールのポイント
                    totalPoints: 0 // ラウンド全体の合計ポイント
                }));
                currentRound.currentHole = 1;

                initializeRecordSection();
                saveGame(); // ラウンド開始時に保存
                showSection(recordSection);
            });

            // ラウンド記録画面の初期化
            function initializeRecordSection() {
                updateHoleDisplay();
                renderPlayerScoreInputs();
                calculateHolePoints(); // スコア入力がなくてもボーナスポイントは計算されるように
                updateCurrentPointsSummary();
                updateNavigationButtons();
            }

            // ホール表示の更新
            function updateHoleDisplay() {
                currentHoleDisplay.textContent = `HOLE ${currentRound.currentHole}`;
                const par = currentRound.holePars[currentRound.currentHole - 1];
                holeParDisplay.textContent = `PAR ${par}`;
            }

            // プレイヤーごとのスコア入力UIの描画
            function renderPlayerScoreInputs() {
                playerScoreInputs.innerHTML = '';
                currentRound.players.forEach((player, playerIndex) => {
                    const holeScore = player.scores[currentRound.currentHole - 1];
                    const selectedBonus = player.holeBonuses[currentRound.currentHole - 1]; // 選択されているボーナス

                    const scoreInputDiv = document.createElement('div');
                    scoreInputDiv.className = 'flex flex-col bg-gray-50 p-3 rounded-lg shadow-sm';
                    scoreInputDiv.innerHTML = `
                        <div class="flex items-center mb-2">
                            <span class="font-semibold text-lg w-24">${player.name}:</span>
                            <div class="flex items-center ml-auto">
                                <button class="score-minus-btn bg-red-400 hover:bg-red-500 text-white font-bold py-1 px-3 rounded-l-lg transition duration-300 ease-in-out transform hover:scale-105" data-player-index="${playerIndex}">-</button>
                                <input type="number" class="score-input w-20 text-center border-t border-b border-gray-300 py-1 text-gray-800 text-lg font-bold focus:outline-none" value="${holeScore !== null ? holeScore : ''}" placeholder="スコア" data-player-index="${playerIndex}">
                                <button class="score-plus-btn bg-green-400 hover:bg-green-500 text-white font-bold py-1 px-3 rounded-r-lg transition duration-300 ease-in-out transform hover:scale-105" data-player-index="${playerIndex}">+</button>
                            </div>
                        </div>
                        <div class="flex flex-wrap justify-center gap-1 mt-2">
                            <button class="bonus-btn bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-2 rounded-full text-xs ${selectedBonus === 'diamond' ? 'selected-bonus' : ''}" data-bonus-type="diamond" data-player-index="${playerIndex}">💎 ダイヤ (+4)</button>
                            <button class="bonus-btn bg-yellow-300 hover:bg-yellow-400 text-yellow-800 font-bold py-1 px-2 rounded-full text-xs ${selectedBonus === 'gold' ? 'selected-bonus' : ''}" data-bonus-type="gold" data-player-index="${playerIndex}">🥇 金 (+3)</button>
                            <button class="bonus-btn bg-gray-400 hover:bg-gray-500 text-gray-800 font-bold py-1 px-2 rounded-full text-xs ${selectedBonus === 'silver' ? 'selected-bonus' : ''}" data-bonus-type="silver" data-player-index="${playerIndex}">🥈 銀 (+2)</button>
                            <button class="bonus-btn bg-orange-300 hover:bg-orange-400 text-orange-800 font-bold py-1 px-2 rounded-full text-xs ${selectedBonus === 'bronze' ? 'selected-bonus' : ''}" data-bonus-type="bronze" data-player-index="${playerIndex}">🥉 銅 (+1)</button>
                        </div>
                    `;
                    playerScoreInputs.appendChild(scoreInputDiv);

                    // スコア入力とボタンのイベントリスナー
                    scoreInputDiv.querySelector('.score-input').addEventListener('change', (e) => {
                        const playerIndex = parseInt(e.target.dataset.playerIndex, 10);
                        let score = parseInt(e.target.value, 10);
                        if (isNaN(score) || score < 1) {
                            score = null; // 無効な入力はnullに戻す
                            e.target.value = '';
                        }
                        currentRound.players[playerIndex].scores[currentRound.currentHole - 1] = score;
                        calculateHolePoints();
                        updateCurrentPointsSummary();
                        saveGame(); // スコア変更時に保存
                    });

                    scoreInputDiv.querySelectorAll('.score-plus-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const playerIndex = parseInt(e.target.dataset.playerIndex, 10);
                            const input = scoreInputDiv.querySelector(`.score-input[data-player-index="${playerIndex}"]`);
                            let score = parseInt(input.value, 10) || 0;
                            score++;
                            input.value = score;
                            currentRound.players[playerIndex].scores[currentRound.currentHole - 1] = score;
                            calculateHolePoints();
                            updateCurrentPointsSummary();
                            saveGame(); // スコア変更時に保存
                        });
                    });

                    scoreInputDiv.querySelectorAll('.score-minus-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const playerIndex = parseInt(e.target.dataset.playerIndex, 10);
                            const input = scoreInputDiv.querySelector(`.score-input[data-player-index="${playerIndex}"]`);
                            let score = parseInt(input.value, 10) || 0;
                            if (score > 1) { // スコアは1未満にならない
                                score--;
                            }
                            input.value = score;
                            currentRound.players[playerIndex].scores[currentRound.currentHole - 1] = score;
                            calculateHolePoints();
                            updateCurrentPointsSummary();
                            saveGame(); // スコア変更時に保存
                        });
                    });

                    // ボーナスボタンのイベントリスナー
                    scoreInputDiv.querySelectorAll('.bonus-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const playerIndex = parseInt(e.target.dataset.playerIndex, 10);
                            const bonusType = e.target.dataset.bonusType;
                            const currentPlayer = currentRound.players[playerIndex];
                            const currentHoleIndex = currentRound.currentHole - 1;

                            // ボーナスの選択をトグル
                            if (currentPlayer.holeBonuses[currentHoleIndex] === bonusType) {
                                currentPlayer.holeBonuses[currentHoleIndex] = null; // 選択解除
                            } else {
                                currentPlayer.holeBonuses[currentHoleIndex] = bonusType; // 新しいボーナスを選択
                            }
                            // UIを更新するために再描画
                            renderPlayerScoreInputs();
                            calculateHolePoints();
                            updateCurrentPointsSummary();
                            saveGame(); // ボーナス変更時に保存
                        });
                    });
                });
            }

            // ホールごとのポイント計算 (オリンピック形式の簡易版)
            function calculateHolePoints() {
                const currentHolePar = currentRound.holePars[currentRound.currentHole - 1];
                let lowestScore = Infinity;
                let lowestScorePlayers = [];

                // まず、そのホールの最低スコアを見つける
                currentRound.players.forEach(player => {
                    const score = player.scores[currentRound.currentHole - 1];
                    if (score !== null && score < lowestScore) {
                        lowestScore = score;
                        lowestScorePlayers = [player];
                    } else if (score !== null && score === lowestScore) {
                        lowestScorePlayers.push(player);
                    }
                });

                currentRound.players.forEach(player => {
                    const score = player.scores[currentRound.currentHole - 1];
                    let points = 0;

                    if (score === null) {
                        player.currentPoints = 0; // スコアが未入力ならポイントなし
                        // ただし、ボーナスポイントはスコア未入力でも加算されるようにする
                    } else {
                        const scoreDiff = score - currentHolePar; // パーとの差

                        // 基本ポイント (簡易的なオリンピックルール)
                        if (scoreDiff === -2) { // イーグル
                            points = 3;
                        } else if (scoreDiff === -1) { // バーディー
                            points = 2;
                        } else if (scoreDiff === 0) { // パー
                            points = 1;
                        } else if (scoreDiff === 1) { // ボギー
                            points = 0; // ボギーはポイントなし
                        } else { // ダブルボギー以上
                            points = -1; // ダブルボギー以上はマイナスポイント
                        }

                        // そのホールのベストスコアだった場合、追加ポイント
                        if (lowestScorePlayers.length === 1 && lowestScorePlayers[0].name === player.name) {
                            points += 1; // ベストスコアボーナス
                        }
                    }

                    // ダイヤ/金/銀/銅ボタンからのボーナスポイントを加算
                    const bonusType = player.holeBonuses[currentRound.currentHole - 1];
                    if (bonusType === 'diamond') {
                        points += 4;
                    } else if (bonusType === 'gold') {
                        points += 3;
                    } else if (bonusType === 'silver') {
                        points += 2;
                    } else if (bonusType === 'bronze') {
                        points += 1;
                    }

                    player.currentPoints = points;
                });
            }

            // 現在のポイントサマリーUIの更新
            function updateCurrentPointsSummary() {
                currentPointsSummary.innerHTML = '';
                currentRound.players.forEach(player => {
                    const playerPointsDiv = document.createElement('div');
                    playerPointsDiv.className = 'flex justify-between items-center';
                    playerPointsDiv.innerHTML = `
                        <span class="font-medium">${player.name}:</span>
                        <span class="font-bold text-lg ${player.currentPoints >= 0 ? 'text-green-700' : 'text-red-700'}">${player.currentPoints} Pts</span>
                    `;
                    currentPointsSummary.appendChild(playerPointsDiv);
                });
            }

            // ナビゲーションボタンの状態更新
            function updateNavigationButtons() {
                prevHoleBtn.disabled = currentRound.currentHole === 1;
                nextHoleBtn.textContent = currentRound.currentHole === currentRound.maxHoles ? 'ラウンド終了' : '次のホール';
                nextHoleBtn.classList.toggle('bg-blue-500', currentRound.currentHole < currentRound.maxHoles);
                nextHoleBtn.classList.toggle('hover:bg-blue-600', currentRound.currentHole < currentRound.maxHoles);
                nextHoleBtn.classList.toggle('bg-green-600', currentRound.currentHole === currentRound.maxHoles);
                nextHoleBtn.classList.toggle('hover:bg-green-700', currentRound.currentHole === currentRound.maxHoles);
                endRoundBtn.style.display = currentRound.currentHole === currentRound.maxHoles ? 'none' : 'block'; // 最終ホールでは非表示
            }

            prevHoleBtn.addEventListener('click', () => {
                if (currentRound.currentHole > 1) {
                    currentRound.currentHole--;
                    initializeRecordSection();
                    saveGame(); // ホール移動時に保存
                }
            });

            nextHoleBtn.addEventListener('click', () => {
                // 現在のホールの全プレイヤーのスコアが入力されているかチェック
                // ボーナスポイントはスコアが未入力でも加算されるため、ここではスコアのみをチェック
                const allScoresEntered = currentRound.players.every(player =>
                    player.scores[currentRound.currentHole - 1] !== null
                );

                if (!allScoresEntered) {
                    showMessageBox('現在のホールの全プレイヤーのスコアを入力してください。');
                    return;
                }

                // 現在のホールのポイントを合計ポイントに加算
                currentRound.players.forEach(player => {
                    player.totalPoints += player.currentPoints;
                });

                if (currentRound.currentHole < currentRound.maxHoles) {
                    currentRound.currentHole++;
                    initializeRecordSection();
                    saveGame(); // ホール移動時に保存
                } else {
                    // 最終ホールの場合、結果画面へ
                    endRound();
                }
            });

            endRoundBtn.addEventListener('click', () => {
                // 途中終了の場合も、現在のホールのポイントを加算
                const allScoresEntered = currentRound.players.every(player =>
                    player.scores[currentRound.currentHole - 1] !== null
                );

                if (!allScoresEntered) {
                    showMessageBox('現在のホールの全プレイヤーのスコアを入力してからラウンドを終了してください。');
                    return;
                }

                currentRound.players.forEach(player => {
                    player.totalPoints += player.currentPoints;
                });
                endRound();
            });

            // ラウンド終了処理
            function endRound() {
                renderResults();
                showSection(resultsSection);
                clearSavedGame(); // ラウンド終了時に保存データをクリア
            }

            // 結果画面の描画
            function renderResults() {
                let maxPoints = -Infinity;
                let winners = [];

                currentRound.players.forEach(player => {
                    if (player.totalPoints > maxPoints) {
                        maxPoints = player.totalPoints;
                        winners = [player.name];
                    } else if (player.totalPoints === maxPoints) {
                        winners.push(player.name);
                    }
                });

                if (winners.length === 1) {
                    finalWinnerDisplay.innerHTML = `<p class="text-gray-600 text-lg">最終的な勝者:</p><p class="text-4xl font-extrabold text-indigo-700">${winners[0]}さん！</p>`;
                } else if (winners.length > 1) {
                    finalWinnerDisplay.innerHTML = `<p class="text-gray-600 text-lg">最終的な勝者:</p><p class="text-4xl font-extrabold text-indigo-700">${winners.join(', ')}さん (同点)</p>`;
                } else {
                    finalWinnerDisplay.innerHTML = `<p class="text-gray-600 text-lg">最終的な勝者:</p><p class="text-4xl font-extrabold text-gray-500">勝者なし</p>`;
                }


                // プレイヤー別最終成績
                finalPlayerSummary.innerHTML = '';
                currentRound.players.forEach(player => {
                    const totalBetAmount = player.totalPoints * currentRound.betAmount;
                    const playerSummaryDiv = document.createElement('div');
                    playerSummaryDiv.className = 'flex justify-between items-center border-b pb-2 last:border-b-0';
                    playerSummaryDiv.innerHTML = `
                        <span class="font-semibold text-gray-800">${player.name}:</span>
                        <div>
                            <span class="font-bold text-lg ${player.totalPoints >= 0 ? 'text-green-700' : 'text-red-700'}">${player.totalPoints} Pts</span>
                            <span class="ml-4 text-gray-600">(${totalBetAmount >= 0 ? '+' : ''}${totalBetAmount}円)</span>
                        </div>
                    `;
                    finalPlayerSummary.appendChild(playerSummaryDiv);
                });

                // ホール別詳細
                holeByHoleDetails.innerHTML = '';
                for (let i = 0; i < currentRound.currentHole; i++) { // プレイしたホールのみ表示
                    const holeNum = i + 1;
                    const par = currentRound.holePars[i];
                    const holeDetailDiv = document.createElement('div');
                    holeDetailDiv.className = 'bg-gray-50 p-4 rounded-lg shadow-sm';
                    holeDetailDiv.innerHTML = `
                        <h4 class="text-md font-bold text-gray-800 mb-2">HOLE ${holeNum} (PAR ${par})</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            ${currentRound.players.map(player => {
                                const score = player.scores[i];
                                const bonusAward = player.holeBonuses[i];
                                let scoreText = score !== null ? `${score}打` : '未入力';
                                let bonusText = '';
                                if (bonusAward === 'diamond') bonusText = ' (💎)';
                                else if (bonusAward === 'gold') bonusText = ' (🥇)';
                                else if (bonusAward === 'silver') bonusText = ' (🥈)';
                                else if (bonusAward === 'bronze') bonusText = ' (🥉)';

                                return `
                                    <div class="flex justify-between">
                                        <span>${player.name}:</span>
                                        <span class="font-semibold">${scoreText}${bonusText}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                    holeByHoleDetails.appendChild(holeDetailDiv);
                }
            }

            backToHomeFromResultsBtn.addEventListener('click', () => {
                showSection(homeSection);
                checkSavedGameAndShowResumeButton(); // ホームに戻ったら再開ボタンの状態を更新
            });

            // 保存されたゲームがあるかチェックし、再開ボタンの表示を切り替える関数
            function checkSavedGameAndShowResumeButton() {
                const savedRound = loadGame();
                if (savedRound) {
                    resumeRoundBtn.classList.remove('hidden');
                } else {
                    resumeRoundBtn.classList.add('hidden');
                }
            }

            // アプリ起動時の初期表示
            document.addEventListener('DOMContentLoaded', () => {
                showSection(homeSection);
                checkSavedGameAndShowResumeButton(); // ページ読み込み時に保存データを確認
            });
        </script>
    </body>
    </html>
