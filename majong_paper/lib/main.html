<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>麻雀 点数記録（横一列＋大型入力）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ color-scheme: light; }
    body { font-family: ui-rounded, system-ui, -apple-system, "Helvetica Neue", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; }
    .cell { appearance: textfield; font-variant-numeric: tabular-nums; }
    .cell::-webkit-outer-spin-button,.cell::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
    .active-cell{ outline: 2px solid rgba(37,99,235,.9); outline-offset: -2px; }
    @media print{ header, .no-print, #wideWrap, #dock { display:none !important; } #gridWrap{ display:block !important; } body{ background:#fff; } }
  </style>
</head>
<body class="bg-slate-50 text-gray-900">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="sticky top-0 z-40 backdrop-blur bg-white/80 border-b border-slate-200">
      <div class="max-w-6xl mx-auto px-3 py-2 flex items-center gap-2">
        <h1 class="font-semibold text-base sm:text-lg">点数記録</h1>
        <div class="ml-auto flex items-center gap-2 text-sm no-print">
          <label class="inline-flex items-center gap-1.5 bg-slate-100 px-2.5 py-1.5 rounded-xl">
            人数
            <select id="playerCount" class="bg-white rounded-lg px-2 py-1 border">
              <option value="4" selected>4</option>
              <option value="5">5</option>
            </select>
          </label>
          <label class="inline-flex items-center gap-2 bg-slate-100 px-2.5 py-1.5 rounded-xl">
            列幅
            <input id="colWidth" type="range" min="32" max="56" value="40" class="w-28">
          </label>
          <button id="printBtn" class="px-3 py-1.5 rounded-xl bg-slate-900 text-white">印刷</button>
        </div>
      </div>
    </header>

    <main class="flex-1">
      <section class="max-w-6xl mx-auto p-3 space-y-3">
        <!-- 横一列テーブル（スマホ優先） -->
        <div id="wideWrap" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-x-auto">
          <!-- injected by JS -->
        </div>

        <!-- 用紙風（印刷/PC） -->
        <div id="gridWrap" class="hidden sm:block bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden"></div>

        <p class="text-[11px] text-slate-500 no-print">※ セルをタップ→下部の<strong>大型入力欄</strong>で数値を入れて「セット」。チェックで「セット後に次の回へ」。PCは用紙風＆印刷向け。</p>
      </section>
    </main>
  </div>

  <!-- Bottom Dock: 大型入力欄 -->
  <div id="dock" class="fixed bottom-0 inset-x-0 z-50 hidden">
    <div class="mx-auto max-w-6xl px-2 pb-[env(safe-area-inset-bottom)]">
      <div class="m-2 rounded-2xl border border-slate-200 bg-white shadow-xl p-3">
        <div class="flex items-center justify-between mb-2">
          <div id="dockInfo" class="text-sm font-medium text-slate-700">—</div>
          <button id="dockClose" class="px-2 py-1 text-slate-500 hover:text-slate-700">閉じる</button>
        </div>
        <div class="flex items-center gap-2">
          <input id="bigVal" inputmode="numeric" type="tel" placeholder="0" class="flex-1 text-2xl font-bold text-right px-3 py-2 border rounded-xl">
          <button id="btnSet" class="px-4 py-2 rounded-xl bg-slate-900 text-white text-base">セット</button>
        </div>
        <div class="mt-2 flex flex-wrap gap-2">
          <button class="px-3 py-1.5 rounded-xl bg-slate-100" data-chip="100">100</button>
          <button class="px-3 py-1.5 rounded-xl bg-slate-100" data-chip="300">300</button>
          <button class="px-3 py-1.5 rounded-xl bg-slate-100" data-chip="500">500</button>
          <button class="px-3 py-1.5 rounded-xl bg-slate-100" data-chip="1000">1,000</button>
          <button class="px-3 py-1.5 rounded-xl bg-slate-100" data-chip="2000">2,000</button>
          <button class="px-3 py-1.5 rounded-xl bg-slate-100" data-chip="3000">3,000</button>
          <button class="px-3 py-1.5 rounded-xl bg-slate-100" data-chip="5000">5,000</button>
        </div>
        <div class="mt-2 flex items-center justify-between text-sm">
          <label class="inline-flex items-center gap-2">
            <input id="autoNext" type="checkbox" class="accent-blue-600">
            <span>セット後に次の回へ</span>
          </label>
          <div class="flex items-center gap-2">
            <button id="btnPrevRow" class="px-3 py-1.5 rounded-xl bg-slate-100">前</button>
            <button id="btnNextRow" class="px-3 py-1.5 rounded-xl bg-slate-100">次</button>
            <button id="btnClear" class="px-3 py-1.5 rounded-xl bg-rose-50 text-rose-700 border border-rose-200">クリア</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const state = { players: 4, rounds: 8, colW: 40, names: ['東家','南家','西家','北家','ゲスト'], autoNext: false };
    const $ = (s, r=document)=>r.querySelector(s);
    let active = null; // {el,p,r,sig}

    function build(){ buildMobileRow(); buildDesktop(); recalc(); }

    // -------- 横一列（モバイル） --------
    function buildMobileRow(){
      const P = state.players; const R = state.rounds; const wrap = $('#wideWrap');
      wrap.innerHTML = '';

      const cont = document.createElement('div');
      cont.className = 'p-3';
      cont.style.setProperty('--w', state.colW + 'px');

      // Header: names row
      const names = document.createElement('div');
      names.className = 'grid gap-px bg-slate-200';
      names.style.gridTemplateColumns = `var(--w) repeat(${P}, calc(var(--w)*2))`;
      const corner = document.createElement('div');
      corner.className = 'bg-slate-50 text-[11px] flex items-center justify-center py-1.5';
      corner.textContent = '回';
      names.appendChild(corner);
      for(let i=0;i<P;i++){
        const cell = document.createElement('div');
        cell.className = 'bg-white p-1';
        cell.innerHTML = `<input type="text" class="w-full bg-white border rounded-lg px-2 py-1 text-[13px]" placeholder="氏名" data-name-p="${i}" value="${state.names[i]||''}">`;
        names.appendChild(cell);
      }

      // Header: + / -
      const pm = document.createElement('div');
      pm.className = 'grid gap-px bg-slate-200';
      pm.style.gridTemplateColumns = `var(--w) repeat(${P*2}, var(--w))`;
      pm.appendChild(Object.assign(document.createElement('div'),{className:'bg-slate-50 text-[11px] flex items-center justify-center py-1.5',textContent:''}));
      for(let i=0;i<P;i++) for(const s of ['＋','−']){
        const c = document.createElement('div');
        c.className = 'bg-slate-50 text-[11px] text-slate-600 flex items-center justify-center py-1.5';
        c.textContent = s; pm.appendChild(c);
      }

      // Body rows 1..R
      const body = document.createElement('div');
      body.className = 'grid gap-px bg-slate-200';
      body.style.gridTemplateColumns = `var(--w) repeat(${P*2}, var(--w))`;
      for(let r=1;r<=R;r++){
        const head = Object.assign(document.createElement('div'),{className:'bg-white text-[13px] flex items-center justify-center py-1.5',textContent:String(r)});
        body.appendChild(head);
        for(let p=0;p<P;p++) for(const sig of ['plus','minus']){
          const c = document.createElement('div');
          c.className = 'bg-white';
          c.innerHTML = `<input inputmode="numeric" type="number" step="100" class="cell w-full text-right px-1.5 py-1.5 text-[13px]" data-view="m" data-r="${r}" data-p="${p}" data-sig="${sig}" placeholder="0">`;
          body.appendChild(c);
        }
      }

      // Subtotal row
      const sub = document.createElement('div');
      sub.className = 'grid gap-px bg-slate-200';
      sub.style.gridTemplateColumns = `var(--w) repeat(${P*2}, var(--w))`;
      sub.appendChild(Object.assign(document.createElement('div'),{className:'bg-slate-50 text-[12px] font-semibold flex items-center justify-center py-1.5',textContent:'小計'}));
      for(let p=0;p<P;p++) for(const k of ['plus','minus']){
        const c = document.createElement('div');
        c.className = 'bg-white text-right px-1.5 py-1.5 text-[13px] tabular-nums';
        c.dataset.role='sub'; c.dataset.kind=k; c.dataset.p=p; c.textContent='0';
        sub.appendChild(c);
      }

      // Total row
      const total = document.createElement('div');
      total.className = 'grid gap-px bg-slate-200';
      total.style.gridTemplateColumns = `var(--w) repeat(${P*2}, var(--w))`;
      total.appendChild(Object.assign(document.createElement('div'),{className:'bg-slate-50 text-[12px] font-semibold flex items-center justify-center py-1.5',textContent:'合計'}));
      for(let p=0;p<P;p++){
        const c1 = document.createElement('div');
        c1.className = 'bg-white text-right font-bold px-1.5 py-1.5 text-[13px] tabular-nums text-slate-900';
        c1.dataset.role='total'; c1.dataset.p=p; c1.textContent='0';
        total.appendChild(c1);
        const pad = document.createElement('div'); pad.className = 'bg-slate-50'; total.appendChild(pad);
      }

      cont.appendChild(names); cont.appendChild(pm); cont.appendChild(body); cont.appendChild(sub); cont.appendChild(total);
      wrap.appendChild(cont);

      wrap.addEventListener('input', onInput, { passive: true });
      wrap.addEventListener('input', onNameInput, { passive: true });
    }

    // -------- 用紙風（印刷/PC） --------
    function buildDesktop(){
      const P = state.players; const R = state.rounds; const wrap = $('#gridWrap');
      wrap.innerHTML = '';

      const top = document.createElement('div');
      top.className = 'px-4 pt-4 grid grid-cols-12 gap-3 text-sm';
      top.innerHTML = `<label class=\"col-span-4 flex items-center gap-2\">月 <input type=number min=1 max=12 class=\"w-16 bg-white border rounded-lg px-2 py-1\"> 日 <input type=number min=1 max=31 class=\"w-16 bg-white border rounded-lg px-2 py-1\"></label><label class=\"col-span-3 flex items-center gap-2\">No. <input type=text class=\"w-24 bg-white border rounded-lg px-2 py-1\" /></label>`;
      wrap.appendChild(top);

      const container = document.createElement('div'); container.className = 'px-4 pb-4';
      const row1 = document.createElement('div'); row1.className = 'grid gap-px bg-slate-200'; row1.style.gridTemplateColumns = `80px repeat(${P}, minmax(160px, 1fr))`;
      const corner = document.createElement('div'); corner.className = 'bg-slate-50 text-slate-600 text-sm flex items-center justify-center py-2'; corner.textContent='回数'; row1.appendChild(corner);
      for(let i=0;i<P;i++){ const c = document.createElement('div'); c.className='bg-white p-2'; c.innerHTML = `<input type=text class=\"w-full bg-white border rounded-lg px-2 py-1 font-medium\" placeholder=\"様\" data-name-p=\"${i}\" value=\"${state.names[i]||''}\">`; row1.appendChild(c); }

      const row2 = document.createElement('div'); row2.className = 'grid gap-px bg-slate-200'; row2.style.gridTemplateColumns = `80px repeat(${P*2}, minmax(80px, 1fr))`;
      row2.appendChild(Object.assign(document.createElement('div'),{className:'bg-slate-50'}));
      for(let i=0;i<P;i++) for(const s of ['+','-']){ const c=document.createElement('div'); c.className='bg-slate-50 text-slate-600 text-xs flex items-center justify-center py-2'; c.textContent=s; row2.appendChild(c); }

      const body = document.createElement('div'); body.className='grid gap-px bg-slate-200'; body.style.gridTemplateColumns = `80px repeat(${P*2}, minmax(80px, 1fr))`;
      for(let r=1;r<=R;r++){ const rc=document.createElement('div'); rc.className='bg-white text-sm flex items-center justify-center py-2'; rc.textContent=r; body.appendChild(rc);
        for(let p=0;p<P;p++) for(const sig of ['plus','minus']){ const c=document.createElement('div'); c.className='bg-white'; c.innerHTML=`<input inputmode=numeric type=number step=100 class=\"cell w-full text-right px-2 py-2\" data-view=\"d\" data-r=\"${r}\" data-p=\"${p}\" data-sig=\"${sig}\" placeholder=\"0\">`; body.appendChild(c); }
      }

      const sub = document.createElement('div'); sub.className='grid gap-px bg-slate-200'; sub.style.gridTemplateColumns = `80px repeat(${P*2}, minmax(80px, 1fr))`;
      sub.appendChild(Object.assign(document.createElement('div'),{className:'bg-slate-50 text-sm font-semibold flex items-center justify-center py-2',textContent:'小計'}));
      for(let p=0;p<P;p++) for(const k of ['plus','minus']){ const c=document.createElement('div'); c.className='bg-white text-right font-medium px-2 py-2 tabular-nums'; c.dataset.role='sub'; c.dataset.kind=k; c.dataset.p=p; c.textContent='0'; sub.appendChild(c); }

      const total = document.createElement('div'); total.className='grid gap-px bg-slate-200'; total.style.gridTemplateColumns = `80px repeat(${P*2}, minmax(80px, 1fr))`;
      total.appendChild(Object.assign(document.createElement('div'),{className:'bg-slate-50 text-sm font-semibold flex items-center justify-center py-2',textContent:'合計'}));
      for(let p=0;p<P;p++){ const c1=document.createElement('div'); c1.className='bg-white text-right font-bold px-2 py-2 tabular-nums text-slate-900'; c1.dataset.role='total'; c1.dataset.p=p; c1.textContent='0'; total.appendChild(c1); total.appendChild(Object.assign(document.createElement('div'),{className:'bg-slate-50'})); }

      container.appendChild(row1); container.appendChild(row2); container.appendChild(body); container.appendChild(sub); container.appendChild(total);
      wrap.appendChild(container);

      wrap.addEventListener('input', onInput, { passive: true });
      wrap.addEventListener('input', onNameInput, { passive: true });
    }

    function onInput(e){ if(e.target.matches('input[data-sig]')) recalc(); }

    function onNameInput(e){
      const t = e.target; if(!t.matches('[data-name-p]')) return;
      const idx = parseInt(t.dataset.nameP,10);
      state.names[idx] = t.value;
      document.querySelectorAll(`[data-name-p="${idx}"]`).forEach(el=>{ if(el!==t) el.value = state.names[idx]; });
      if(active && active.p===idx) updateDockInfo();
    }

    // ---- 大型入力欄（Dock） ----
    function openDock(inputEl){
      if(active?.el) active.el.classList.remove('active-cell');
      const p = parseInt(inputEl.dataset.p,10); const r = parseInt(inputEl.dataset.r,10); const sig = inputEl.dataset.sig;
      active = { el: inputEl, p, r, sig };
      inputEl.classList.add('active-cell');
      $('#bigVal').value = inputEl.value || '';
      $('#autoNext').checked = state.autoNext;
      updateDockInfo();
      $('#dock').classList.remove('hidden');
    }

    function closeDock(){ if(active?.el) active.el.classList.remove('active-cell'); active = null; $('#dock').classList.add('hidden'); }

    function updateDockInfo(){ if(!active) return; const sign = active.sig==='plus'?'＋':'−'; $('#dockInfo').textContent = `${state.names[active.p]||`P${active.p+1}`} / ${active.r}回 / ${sign}`; }

    function setFromDock(){ if(!active) return; const v = $('#bigVal').value.trim(); active.el.value = v; active.el.dispatchEvent(new Event('input',{bubbles:true})); if($('#autoNext').checked){ moveRow(1); } }

    function moveRow(delta){ if(!active) return; let r = active.r + delta; if(r<1) r = state.rounds; if(r>state.rounds) r = 1; const sel = `input[data-p="${active.p}"][data-sig="${active.sig}"][data-r="${r}"]`; const next = document.querySelector(sel); if(next){ openDock(next); next.focus({preventScroll:true}); } }

    // Global listeners
    document.addEventListener('focusin', (e)=>{ if(e.target.matches('input[data-sig]')) openDock(e.target); });
    document.addEventListener('click',   (e)=>{ if(e.target.matches('input[data-sig]')) openDock(e.target); });

    $('#dock').addEventListener('click', (e)=>{
      const t = e.target;
      if(t.id==='dockClose') closeDock();
      if(t.id==='btnSet') setFromDock();
      if(t.id==='btnClear' && active){ active.el.value=''; active.el.dispatchEvent(new Event('input',{bubbles:true})); }
      if(t.id==='btnPrevRow') moveRow(-1);
      if(t.id==='btnNextRow') moveRow(1);
      if(t.dataset && t.dataset.chip){ $('#bigVal').value = t.dataset.chip; }
      if(t.id==='autoNext'){ state.autoNext = t.checked; }
    });

    function recalc(){
      const P = state.players; const R = state.rounds;
      for(let p=0;p<P;p++){
        let sPlus=0, sMinus=0;
        for(let r=1;r<=R;r++){
          document.querySelectorAll(`input[data-r="${r}"][data-p="${p}"][data-sig="plus"]`).forEach(i=> sPlus += parseInt(i.value||'0',10)||0);
          document.querySelectorAll(`input[data-r="${r}"][data-p="${p}"][data-sig="minus"]`).forEach(i=> sMinus += parseInt(i.value||'0',10)||0);
        }
        const tot = sPlus - sMinus; const fmt = n=>n.toLocaleString();
        document.querySelectorAll(`[data-role="sub"][data-kind="plus"][data-p="${p}"]`).forEach(el=> el.textContent = fmt(sPlus));
        document.querySelectorAll(`[data-role="sub"][data-kind="minus"][data-p="${p}"]`).forEach(el=> el.textContent = fmt(sMinus));
        document.querySelectorAll(`[data-role="total"][data-p="${p}"]`).forEach(el=> el.textContent = fmt(tot));
      }
    }

    document.addEventListener('change', (e)=>{
      if(e.target.id==='playerCount'){
        state.players = parseInt(e.target.value,10); build(); if(active) closeDock();
      }
      if(e.target.id==='colWidth'){
        state.colW = parseInt(e.target.value,10); buildMobileRow(); recalc();
      }
      if(e.target.id==='autoNext'){ state.autoNext = e.target.checked; }
    });

    $('#printBtn').addEventListener('click', ()=> window.print());

    build();
  </script>
</body>
</html>
